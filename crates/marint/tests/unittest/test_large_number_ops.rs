#[cfg(test)]
mod test_large_number_ops {
    use super::*;
    use marint::MSgn;
    use marint::MSgn::*;
    use marint::MarInt;

    #[derive(Clone, Debug)]
    struct Case {
        a_sign: i8,
        a_limbs: &'static [u64],
        b_sign: i8,
        b_limbs: &'static [u64],
        op: char,
        c_sign: i8,
        c_limbs: &'static [u64],
    }

    fn sgn_from_i8(x: i8) -> MSgn {
        match x {
            -1 => MNeg,
            0 => MZero,
            1 => MPos,
            _ => panic!("invalid sign: {}", x),
        }
    }

    // Normalize to canonical representation:
    // - trim high zero limbs (little-endian => trim from the end)
    // - if limbs become empty => sign must be zero
    fn normalize(mut x: MarInt) -> MarInt {
        while x.limbs.last().copied() == Some(0) {
            x.limbs.pop();
        }
        if x.limbs.is_empty() {
            x.sign = MZero;
        }
        x
    }

    fn mk(sign: i8, limbs: &'static [u64]) -> MarInt {
        normalize(MarInt {
            sign: sgn_from_i8(sign),
            limbs: limbs.to_vec(),
        })
    }

    const CASES: &[Case] = &[
        Case {
            a_sign: -1,
            a_limbs: &[
                16362869968789633489u64,
                12016630898417689170u64,
                11354423363985624876u64,
                16613182794197762079u64,
                17224842555786912957u64,
                3514554074612120239u64,
                6466733003993105510u64,
            ],
            b_sign: 1,
            b_limbs: &[
                15669335706744843196u64,
                16221837992768815100u64,
                112888971429266063u64,
                3330961920011854077u64,
                11737275159301615628u64,
                17468860036043777382u64,
                9324588634849573180u64,
                772591364323205734u64,
                6850879030575372456u64,
            ],
            op: '*',
            c_sign: -1,
            c_limbs: &[
                4564331677691170940u64,
                12656241350059354586u64,
                10234741825547641214u64,
                7739064247594168092u64,
                2884080254348322918u64,
                2661040772751181587u64,
                2372813154030266091u64,
                1374100508444537413u64,
                7406838851622630940u64,
                12512321239371041387u64,
                1283956897236078749u64,
                13964806401871053156u64,
                12953536898352385824u64,
                4808048175928548964u64,
                5329289575777942297u64,
                2401659900324999277u64,
            ],
        },
        Case {
            a_sign: 1,
            a_limbs: &[
                7804087670407921751u64,
                5572409966967505532u64,
                14504340286381066637u64,
                1462490832290290957u64,
                15488356074103939146u64,
                3125166142475627382u64,
                12327677115656477285u64,
                6616277028808289735u64,
            ],
            b_sign: -1,
            b_limbs: &[9802524866545265124u64, 9916757239584610589u64],
            op: '+',
            c_sign: 1,
            c_limbs: &[
                16448306877572208243u64,
                14102396801092446558u64,
                14504340286381066636u64,
                1462490832290290957u64,
                15488356074103939146u64,
                3125166142475627382u64,
                12327677115656477285u64,
                6616277028808289735u64,
            ],
        },
        Case {
            a_sign: 1,
            a_limbs: &[
                11761835857171258763u64,
                8800883023378789994u64,
                7124308624034939829u64,
                16500214225059898662u64,
                8373734913370701545u64,
            ],
            b_sign: -1,
            b_limbs: &[
                4682476842028908297u64,
                2325012971747913719u64,
                7283539494480941369u64,
                13426289697082211737u64,
                17538437413179117741u64,
                12558575545224465272u64,
                7998838775545831739u64,
                4203397835849193921u64,
                14320602930629316543u64,
            ],
            op: '-',
            c_sign: 1,
            c_limbs: &[
                16444312699200167060u64,
                11125895995126703713u64,
                14407848118515881198u64,
                11479759848432558783u64,
                7465428252840267671u64,
                12558575545224465273u64,
                7998838775545831739u64,
                4203397835849193921u64,
                14320602930629316543u64,
            ],
        },
        Case {
            a_sign: 1,
            a_limbs: &[
                15706098662591242141u64,
                850215896688349888u64,
                13066631582430288852u64,
                2950129106768669222u64,
                6744900116466494753u64,
                10805752222091144036u64,
                15447285313757329037u64,
                11002407073540108008u64,
                1470321542051794267u64,
                14545783163767861199u64,
            ],
            b_sign: -1,
            b_limbs: &[4515144660104129742u64, 2945519892745573562u64],
            op: '+',
            c_sign: 1,
            c_limbs: &[
                11190954002487112399u64,
                16351440077652327942u64,
                13066631582430288851u64,
                2950129106768669222u64,
                6744900116466494753u64,
                10805752222091144036u64,
                15447285313757329037u64,
                11002407073540108008u64,
                1470321542051794267u64,
                14545783163767861199u64,
            ],
        },
        Case {
            a_sign: 1,
            a_limbs: &[
                9689537716534552907u64,
                15645430355631876272u64,
                4073489310303058744u64,
                326449686918182228u64,
                4898196514569643055u64,
                15884343421155157370u64,
                9759129235684606255u64,
            ],
            b_sign: -1,
            b_limbs: &[
                6567040874558712229u64,
                12439924147128667664u64,
                25141600095852126u64,
                18366203548897261016u64,
                14724185393634255162u64,
                6851907146338709766u64,
                9825198298061469791u64,
                12134560906405013767u64,
                10880293307050264455u64,
            ],
            op: '+',
            c_sign: -1,
            c_limbs: &[
                15324247231733710938u64,
                15241237865206343007u64,
                14398396363502344997u64,
                18039753861979078787u64,
                9825988879064612107u64,
                9414307798893104012u64,
                66069062376863535u64,
                12134560906405013767u64,
                10880293307050264455u64,
            ],
        },
        Case {
            a_sign: 1,
            a_limbs: &[
                10404932523516949313u64,
                12110156369092848984u64,
                2651378022003909797u64,
                13811096740166267013u64,
                14661402203403090283u64,
                8087432192689389265u64,
                1025077369576089944u64,
                16567779504583643741u64,
            ],
            b_sign: -1,
            b_limbs: &[
                12709356720522908386u64,
                17383798997496553249u64,
                7798672108985910198u64,
                9116387872575279980u64,
                16156164188528731753u64,
            ],
            op: '-',
            c_sign: 1,
            c_limbs: &[
                4667545170330306083u64,
                11047211292879850618u64,
                10450050130989819996u64,
                4480740539031995377u64,
                12370822318222270421u64,
                8087432192689389266u64,
                1025077369576089944u64,
                16567779504583643741u64,
            ],
        },
        Case {
            a_sign: -1,
            a_limbs: &[
                9148172267582916323u64,
                5212194391254710891u64,
                14921588484282041224u64,
                3829512001257745672u64,
            ],
            b_sign: -1,
            b_limbs: &[
                6281746606614051111u64,
                6488360459852463551u64,
                8046653015854566606u64,
                7016396016323421472u64,
            ],
            op: '*',
            c_sign: 1,
            c_limbs: &[
                12499199714286229397u64,
                10126814195840833501u64,
                6881433008461244569u64,
                10520756795158140260u64,
                9176452809248149932u64,
                9049365551322156264u64,
                4617628435385493898u64,
                1456591615448388359u64,
            ],
        },
        Case {
            a_sign: 1,
            a_limbs: &[
                74923353357818236u64,
                11301606293236318030u64,
                12793525300143039793u64,
                10489044913561314586u64,
                9440131007136280467u64,
                10057027514945812673u64,
                3001826495267364434u64,
                1116017784461507559u64,
            ],
            b_sign: -1,
            b_limbs: &[
                6360398681903975486u64,
                8529778015103663117u64,
                16176339280254145201u64,
                7531085850131959475u64,
                2169436733010297859u64,
                10169976362732944446u64,
                4093673004367664721u64,
            ],
            op: '+',
            c_sign: 1,
            c_limbs: &[
                12161268745163394366u64,
                2771828278132654912u64,
                15063930093598446208u64,
                2957959063429355110u64,
                7270694274125982608u64,
                18333795225922419843u64,
                17354897564609251328u64,
                1116017784461507558u64,
            ],
        },
        Case {
            a_sign: 1,
            a_limbs: &[
                9405745251420427468u64,
                1560532248137681604u64,
                5847089583675616878u64,
                4422395004919567162u64,
                6749585586660051290u64,
                3959467432980676957u64,
            ],
            b_sign: 1,
            b_limbs: &[
                1602049689989579106u64,
                10180700408204974924u64,
                1768361562962208053u64,
                5467450186681931678u64,
                3302786345686531170u64,
                3119484105306010407u64,
                3917831473197315492u64,
                5396190788028693078u64,
            ],
            op: '-',
            c_sign: -1,
            c_limbs: &[
                10643048512278703254u64,
                8620168160067293319u64,
                14368016052996142791u64,
                1045055181762364515u64,
                14999944832736031496u64,
                17606760746034885065u64,
                3917831473197315491u64,
                5396190788028693078u64,
            ],
        },
        Case {
            a_sign: -1,
            a_limbs: &[5186188222756479964u64, 4189646804845310771u64],
            b_sign: -1,
            b_limbs: &[
                4670576369836983797u64,
                1591082441021405019u64,
                1525837251689439552u64,
            ],
            op: '+',
            c_sign: -1,
            c_limbs: &[
                9856764592593463761u64,
                5780729245866715790u64,
                1525837251689439552u64,
            ],
        },
        Case {
            a_sign: -1,
            a_limbs: &[
                5681210937609553257u64,
                13450695409830051594u64,
                9630809342936973828u64,
                6485177116076806934u64,
                12662296170929142820u64,
                4254330992374809329u64,
            ],
            b_sign: -1,
            b_limbs: &[5343315565311436320u64],
            op: '+',
            c_sign: -1,
            c_limbs: &[
                11024526502920989577u64,
                13450695409830051594u64,
                9630809342936973828u64,
                6485177116076806934u64,
                12662296170929142820u64,
                4254330992374809329u64,
            ],
        },
        Case {
            a_sign: 1,
            a_limbs: &[
                4314951370434777315u64,
                11148154562236240075u64,
                12932572054642655143u64,
                15369015332527196830u64,
                3766710790029307879u64,
            ],
            b_sign: -1,
            b_limbs: &[13427242280758311622u64, 9235468131986557283u64],
            op: '+',
            c_sign: 1,
            c_limbs: &[
                9334453163386017309u64,
                1912686430249682791u64,
                12932572054642655143u64,
                15369015332527196830u64,
                3766710790029307879u64,
            ],
        },
        Case {
            a_sign: -1,
            a_limbs: &[
                14060590595798519948u64,
                5558185093213988339u64,
                9612648277244154906u64,
                17180639382744584774u64,
                10082943615154802894u64,
                1534225694973917638u64,
                10371681034372474319u64,
                16778376504338755759u64,
                814942566264492251u64,
                18164723209638877940u64,
            ],
            b_sign: -1,
            b_limbs: &[
                9343358781651609761u64,
                7922635436193701941u64,
                18350550633050548290u64,
                15031264251084135084u64,
            ],
            op: '+',
            c_sign: -1,
            c_limbs: &[
                4957205303740578093u64,
                13480820529407690281u64,
                9516454836585151580u64,
                13765159560119168243u64,
                10082943615154802895u64,
                1534225694973917638u64,
                10371681034372474319u64,
                16778376504338755759u64,
                814942566264492251u64,
                18164723209638877940u64,
            ],
        },
        Case {
            a_sign: 1,
            a_limbs: &[
                11958674956832625707u64,
                5883526771623240748u64,
                12124534384023258036u64,
                15166484355464132331u64,
                13997812568413923748u64,
                13405860827440101333u64,
                17453940629779155385u64,
                12621984103724406841u64,
                15796934545366078806u64,
            ],
            b_sign: -1,
            b_limbs: &[
                5956200456521394723u64,
                4491517804001843455u64,
                608562589430646534u64,
                16044072072604155016u64,
                4441328052955166790u64,
                6859237375908762001u64,
            ],
            op: '*',
            c_sign: -1,
            c_limbs: &[
                12096374020827680737u64,
                8198620928571210293u64,
                17136217417512381695u64,
                17971420652288365813u64,
                2476105300194786973u64,
                12664495130361037678u64,
                10362741977820954992u64,
                4279362357592243326u64,
                2427080253976034602u64,
                10976823877360356653u64,
                18166455278931292442u64,
                1377645722206451169u64,
                150320298932064726u64,
                4946157466806510936u64,
                5873932192336728180u64,
            ],
        },
        Case {
            a_sign: -1,
            a_limbs: &[
                16118450257104210915u64,
                11092802287396558539u64,
                12136942223884500954u64,
                11906461726424439450u64,
                6036218420759705680u64,
                10365026279104793218u64,
                15958364035260195655u64,
                15200058841838723010u64,
                1494411656303517646u64,
                1311496154775791481u64,
            ],
            b_sign: -1,
            b_limbs: &[
                16286073705090267505u64,
                16406885986163805228u64,
                4396054351816390826u64,
                983329857252737417u64,
                7708852289488625766u64,
                1473386911429389102u64,
                14061628011263867534u64,
                1450332800230434463u64,
                7524844305276672058u64,
                12144838584054568808u64,
            ],
            op: '+',
            c_sign: -1,
            c_limbs: &[
                13957779888484926804u64,
                9052944199850812152u64,
                16532996575700891781u64,
                12889791583677176867u64,
                13745070710248331446u64,
                11838413190534182320u64,
                11573247972814511573u64,
                16650391642069157474u64,
                9019255961580189704u64,
                13456334738830360289u64,
            ],
        },
        Case {
            a_sign: -1,
            a_limbs: &[
                17891379618987350153u64,
                6023472146673296959u64,
                15052548942986395815u64,
            ],
            b_sign: 1,
            b_limbs: &[
                7495286177735557981u64,
                7556308374877126503u64,
                18331444750660843629u64,
                10628793087808898794u64,
                5263975632306371914u64,
                13580882548379283685u64,
            ],
            op: '+',
            c_sign: 1,
            c_limbs: &[
                8050650632457759444u64,
                1532836228203829543u64,
                3278895807674447814u64,
                10628793087808898794u64,
                5263975632306371914u64,
                13580882548379283685u64,
            ],
        },
        Case {
            a_sign: -1,
            a_limbs: &[
                11572701445018715884u64,
                17017359098909971942u64,
                684763517068437173u64,
                13765763991346715343u64,
                4801348295202796729u64,
                12607938092404793361u64,
                2894976259746113162u64,
            ],
            b_sign: -1,
            b_limbs: &[15023800023991848045u64, 2805224438506499392u64],
            op: '+',
            c_sign: -1,
            c_limbs: &[
                8149757395301012313u64,
                1375839463706919719u64,
                684763517068437174u64,
                13765763991346715343u64,
                4801348295202796729u64,
                12607938092404793361u64,
                2894976259746113162u64,
            ],
        },
        Case {
            a_sign: 1,
            a_limbs: &[
                454328942505361075u64,
                14005208544446744853u64,
                13733326017120161186u64,
                3664869171255125433u64,
                13144529246401762946u64,
                11605394035999509608u64,
                10542213622002188899u64,
                17996615870841389026u64,
                3656814087625003695u64,
            ],
            b_sign: -1,
            b_limbs: &[9580659937582460324u64, 5212146502421464452u64],
            op: '*',
            c_sign: -1,
            c_limbs: &[
                9063701601577705900u64,
                15728276170791099288u64,
                10250412320040036488u64,
                2749421127284666347u64,
                14754880808818776810u64,
                2999748320658154603u64,
                15140354243291703823u64,
                4851104866727959436u64,
                13385211224342714092u64,
                14215857980127141585u64,
                1033236579889697424u64,
            ],
        },
        Case {
            a_sign: 1,
            a_limbs: &[
                10954090496162820807u64,
                4231385409277339169u64,
                13105387936638070688u64,
                8997907120041996564u64,
                10868290671864929287u64,
            ],
            b_sign: -1,
            b_limbs: &[
                16017262610956397090u64,
                2089346739252784264u64,
                6535636657502085949u64,
                10321369011922253646u64,
            ],
            op: '+',
            c_sign: 1,
            c_limbs: &[
                13383571958915975333u64,
                2142038670024554904u64,
                6569751279135984739u64,
                17123282181829294534u64,
                10868290671864929286u64,
            ],
        },
        Case {
            a_sign: 1,
            a_limbs: &[
                13789558292789678272u64,
                9223975585689964010u64,
                13630462734395321423u64,
                14931734753865576262u64,
                13609322121573513015u64,
                15932400688077696454u64,
                2677772639998725814u64,
            ],
            b_sign: -1,
            b_limbs: &[
                10795074000977271314u64,
                14477852274710177192u64,
                13649644670639460878u64,
                12596032406079908492u64,
                9899895372209046666u64,
                1682493847462630608u64,
                11737441430976117860u64,
                11608980820748167863u64,
            ],
            op: '+',
            c_sign: -1,
            c_limbs: &[
                15452259781897144658u64,
                5253876689020213181u64,
                19181936244139455u64,
                16111041725923883846u64,
                14737317324345085266u64,
                4196837233094485769u64,
                9059668790977392045u64,
                11608980820748167863u64,
            ],
        },
    ];

    #[test]
    fn marint_random_large_cases() {
        for (i, tc) in CASES.iter().enumerate() {
            let a = mk(tc.a_sign, tc.a_limbs);
            let b = mk(tc.b_sign, tc.b_limbs);
            let expected = mk(tc.c_sign, tc.c_limbs);

            // If your ops are implemented for &MarInt instead of owned MarInt,
            // change these lines to: &a + &b, &a - &b, &a * &b
            let got = match tc.op {
                // '+' => normalize(a.clone() + b.clone()),
                // '-' => normalize(a.clone() - b.clone()),
                // '*' => normalize(a.clone() * b.clone()),
                '+' => normalize(&a + &b),
                '-' => normalize(&a - &b),
                '*' => normalize(&a * &b),
                _ => panic!("unknown op: {:?}", tc.op),
            };

            assert_eq!(
                got.sign as i8, expected.sign as i8,
                "case {} sign mismatch: op={} a={:?} b={:?} got={:?} expected={:?}",
                i, tc.op, a, b, got, expected
            );
            assert_eq!(
                got.limbs, expected.limbs,
                "case {} limbs mismatch: op={} a={:?} b={:?} got={:?} expected={:?}",
                i, tc.op, a, b, got, expected
            );
        }
    }
}
